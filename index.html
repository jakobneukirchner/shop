<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mein Online-Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .btn-primary {
            background-color: #3B82F6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563EB;
        }
        .nav-link {
            transition: color 0.2s;
        }
        .nav-link:hover {
            color: #3B82F6;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #FFFFFF;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-8">

    <header class="bg-white p-6 rounded-xl flex items-center justify-between shadow-lg mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Mein Online Shop</h1>
        <nav>
            <a href="#products-section" class="nav-link text-gray-600 mr-4">Home</a>
            <a href="#products-section" class="nav-link text-gray-600 mr-4">Produkte</a>
            <a href="#contact-section" class="nav-link text-gray-600">Kontakt</a>
        </nav>
        <div class="relative">
            <button id="cart-button" class="bg-gray-200 p-3 rounded-full hover:bg-gray-300 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5.2M7 13a2 2 0 100 4m0-4a2 2 0 110 4m7-4a2 2 0 100 4m0-4a2 2 0 110 4"></path>
                </svg>
            </button>
            <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
        </div>
    </header>

    <main id="main-content" class="grid grid-cols-1 gap-6">
        <!-- Products Section -->
        <section id="products-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div id="loading" class="col-span-full text-center text-lg text-gray-500 hidden">Lade Produkte...</div>
            <div id="error-message" class="col-span-full text-center text-red-500 hidden">Produkte konnten nicht geladen werden.</div>
            <div id="product-container" class="col-span-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Contact Section -->
        <section id="contact-section" class="hidden bg-white p-8 rounded-lg shadow-lg text-center">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Kontakt</h2>
            <p class="text-gray-600">
                Für Anfragen oder Unterstützung erreichen Sie uns unter: <a href="mailto:info@meine-shop-seite.de" class="text-blue-500 hover:underline">info@meine-shop-seite.de</a>
            </p>
        </section>
    </main>

    <!-- Modal für Nachrichten -->
    <div id="message-modal" class="modal fixed inset-0 flex items-center justify-center hidden">
        <div class="modal-content p-6 rounded-lg shadow-xl text-center">
            <p id="modal-text" class="text-lg font-semibold mb-4"></p>
            <button id="modal-close" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-full hover:bg-gray-300">Schließen</button>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const stripe = Stripe("pk_live_51S3J7kRe5qX74hi1SIM1tos4THj24Yszjh9fRyKL5VxFFiarH3Y2bFqmpvQIbbsSajwQVl9a4YK4qxZlF8rwGdjh00DZjAYX7x");
        const productContainer = document.getElementById('product-container');
        const cartCount = document.getElementById('cart-count');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error-message');
        const productsSection = document.getElementById('products-section');
        const contactSection = document.getElementById('contact-section');
        const messageModal = document.getElementById('message-modal');
        const modalText = document.getElementById('modal-text');
        const modalCloseBtn = document.getElementById('modal-close');

        let cart = {};
        let products = [];

        const showMessageModal = (message) => {
            modalText.textContent = message;
            messageModal.classList.remove('hidden');
        };

        modalCloseBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        const showSection = (sectionId) => {
            productsSection.classList.add('hidden');
            contactSection.classList.add('hidden');
            document.getElementById(sectionId).classList.remove('hidden');
        };

        const getProducts = async () => {
            loadingDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            try {
                // Neuer, zuverlässiger Pfad zu den statischen Daten
                const response = await fetch('/data/products.json');
                if (!response.ok) throw new Error('Network response was not ok');
                products = await response.json();
                renderProducts();
            } catch (error) {
                console.error("Failed to fetch products:", error);
                errorDiv.classList.remove('hidden');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        };

        const renderProducts = () => {
            productContainer.innerHTML = '';
            if (products.length === 0) {
                const noProductsMessage = document.createElement('p');
                noProductsMessage.className = 'col-span-full text-center text-gray-500';
                noProductsMessage.textContent = 'Aktuell sind keine Produkte verfügbar.';
                productContainer.appendChild(noProductsMessage);
            } else {
                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = "bg-white p-6 rounded-lg shadow-lg card";
                    productCard.innerHTML = `
                        <img src="${product.image}" alt="${product.name}" class="w-full h-48 object-cover rounded-lg mb-4">
                        <h2 class="text-xl font-semibold text-gray-900 mb-2">${product.name}</h2>
                        <p class="text-gray-600 mb-4">${product.description}</p>
                        <div class="flex items-center justify-between">
                            <span class="text-2xl font-bold text-gray-900">${(product.price / 100).toFixed(2)} €</span>
                            <button class="add-to-cart-btn bg-blue-500 text-white py-2 px-4 rounded-full hover:bg-blue-600 transition-colors" data-id="${product.id}">
                                In den Warenkorb
                            </button>
                        </div>
                    `;
                    productContainer.appendChild(productCard);
                });
            }
        };

        const updateCartCount = () => {
            const totalItems = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
        };

        const handleAddToCart = (e) => {
            const button = e.target.closest('.add-to-cart-btn');
            if (button) {
                const productId = button.dataset.id;
                const product = products.find(p => p.id === productId);
                if (product) {
                    if (cart[productId]) {
                        cart[productId].quantity++;
                    } else {
                        cart[productId] = { ...product, quantity: 1 };
                    }
                    updateCartCount();
                    showMessageModal(`${product.name} wurde dem Warenkorb hinzugefügt!`);
                }
            }
        };

        const handleCheckout = async () => {
            const items = Object.values(cart).map(item => ({
                id: item.id,
                quantity: item.quantity
            }));

            try {
                const response = await fetch('/.netlify/functions/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items })
                });

                if (!response.ok) throw new Error('Failed to create checkout session');

                const { sessionId } = await response.json();
                const result = await stripe.redirectToCheckout({ sessionId });

                if (result.error) {
                    showMessageModal(result.error.message);
                }
            } catch (error) {
                console.error("Checkout failed:", error);
                showMessageModal("Fehler beim Checkout. Bitte versuchen Sie es erneut.");
            }
        };

        getProducts();

        document.addEventListener('click', handleAddToCart);
        document.getElementById('cart-button').addEventListener('click', handleCheckout);

        document.querySelector('nav').addEventListener('click', (e) => {
            e.preventDefault();
            const href = e.target.getAttribute('href');
            if (href && href.startsWith('#')) {
                const sectionId = href.substring(1);
                showSection(sectionId);
            }
        });
    </script>
</body>
</html>
